name: ðŸ”‹ Compile Common Image for Lilygo

on:
  # The workflow is run when a commit is pushed or for a
  # Pull Request.
  - push
  - pull_request

# This is the list of jobs that will be run concurrently.
jobs:
  # This pre-job is run to skip workflows in case a workflow is already run, i.e. because the workflow is triggered by both push and pull_request
  skip-duplicate-actions:
    runs-on: ubuntu-latest
    # Map a step output to a job output
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          # All of these options are optional, so you can remove them if you are happy with the defaults
          concurrent_skipping: 'never'
          skip_after_successful_duplicate: 'true'
          do_not_skip: '["pull_request", "workflow_dispatch", "schedule"]'

  build-common-image:
    # This is the platform GitHub will use to run our workflow.
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      name: Checkout code

    - uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          ~/.platformio/.cache
        key: ${{ runner.os }}-pio

    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install PlatformIO Core
      run: pip install --upgrade platformio

      # Copy USER_SECRETS.TEMPLATE.h to USER_SECRETS.h
    - name: Copy USER_SECRETS.TEMPLATE.h to USER_SECRETS.h
      run: cp ./Software/USER_SECRETS.TEMPLATE.h ./Software/USER_SECRETS.h

    - name: Build image for Lilygo
      run: pio run -e lilygo_330

    - name: Build image for Lilygo
      run: esptool --chip esp32 merge-bin -o .pio/build/lilygo_330/merged-firmware.bin --flash-mode dio --flash-freq 40m --flash-size 4MB 0x1000 .pio/build/lilygo_330/bootloader.bin 0x8000 .pio/build/lilygo_330/partitions.bin 0xe000 ~/.platformio/packages/framework-arduinoespressif32/tools/partitions/boot_app0.bin 0x10000 .pio/build/lilygo_330/firmware.bin

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: battery-emulator-lilygo.bin
        path: .pio/build/lilygo_330/firmware.bin
